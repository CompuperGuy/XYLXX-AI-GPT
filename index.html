<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XYLXX GPT-1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">XYLXX GPT-1</div>
    </div>
    <div class="chat">
      <div class="messages" id="messages"></div>
      <div class="composer">
        <textarea id="inputBox" placeholder="Type a message..."></textarea>
        <button id="sendBtn">‚û§</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { buildModel, generateReply, loadVocab, rewardTrain } from './model.js';
    import { saveChat, saveReward } from './firebase.js';

    const messages = document.getElementById('messages');
    const inputBox = document.getElementById('inputBox');
    const sendBtn = document.getElementById('sendBtn');

    let vocab = {};
    let model;

    async function init() {
      addMessage("Loading XYLXX GPT-1...", "sys");
      vocab = await loadVocab("./vocab.json");
      model = buildModel(Object.keys(vocab).length);
      addMessage("‚úÖ Ready! Type a message.", "sys");
    }
    init();

    async function handleSend() {
      const text = inputBox.value.trim();
      if (!text) return;
      inputBox.value = "";
      addMessage(text, "user");

      try {
        const reply = await generateReply(model, vocab, text);
        const msgId = Date.now().toString();
        addMessage(reply, "bot", msgId);
        await saveChat(text, reply, msgId);
      } catch (err) {
        console.error(err);
        addMessage("‚ö†Ô∏è Error: " + err.message, "sys");
      }
    }

    function addMessage(text, who, msgId = null) {
      const div = document.createElement('div');
      div.className = `msg ${who}`;

      if(who === "bot") {
        div.innerHTML = `<div class="botText">${text}</div>`;
        if(msgId){
          const feedback = document.createElement('div');
          feedback.className = 'feedback';
          const up = document.createElement('button');
          up.className = 'vote'; up.textContent = 'üëç';
          up.onclick = async () => { await saveReward(msgId,1); rewardTrain(model, vocab, text,true); feedback.style.display='none'; };
          const down = document.createElement('button');
          down.className = 'vote'; down.textContent = 'üëé';
          down.onclick = async () => { await saveReward(msgId,-1); rewardTrain(model,vocab,text,false); feedback.style.display='none'; };
          feedback.append(up,down);
          div.appendChild(feedback);
        }
      } else {
        div.textContent = text;
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    sendBtn.addEventListener('click', handleSend);
    inputBox.addEventListener('keydown', e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
  </script>
</body>
</html>
