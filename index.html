<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>XYLXX GPT-1</title>
<link rel="icon" href="data:," />
<style>
  /* Minimal ChatGPT-like clean layout (only chat visible) */
  :root{
    --bg:#0b0b0c; --panel:#0f1113; --muted:#9aa0a6; --accent:#10a37f;
    --user:#0b63ff; --bot:#dff7ea;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%;padding:24px;}
  .chat {
    width:820px; max-width:98vw; height:88vh; background:var(--panel);
    border-radius:12px; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,.7)
  }
  .topbar{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03);}
  .brand{font-weight:600;color:#fff;margin-right:12px}
  .subtitle{color:var(--muted);font-size:13px}
  .messages{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .bubble{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.45;font-size:15px}
  .user{align-self:flex-end;background:linear-gradient(135deg,var(--user),#2b6fbf);color:white;border-bottom-right-radius:4px}
  .bot{align-self:flex-start;background:linear-gradient(180deg,#0f2518,var(--bot));color:#022;border-bottom-left-radius:4px}
  .metaRow{display:flex;gap:8px;align-items:center;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  .votes{margin-left:auto;display:flex;gap:8px}
  .voteBtn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
  .inputRow{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.03)}
  .textbox{flex:1;padding:12px;border-radius:10px;background:#0b0c0d;border:0;color:#fff;font-size:15px;outline:none}
  .sendBtn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
  .hint{color:var(--muted);font-size:13px;padding:8px 18px}
  /* tighten mobile */
  @media (max-width:640px){ .chat{width:100%;height:96vh;border-radius:8px} }
</style>
</head>
<body>
  <div class="wrap">
    <main class="chat" role="main" aria-label="XYLXX GPT-1 chat">
      <div class="topbar">
        <div class="brand">XYLXX GPT-1</div>
        <div class="subtitle">All replies generated by in-browser neural network</div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="inputRow">
        <input id="inputBox" class="textbox" placeholder="Send a message..." autocomplete="off" />
        <button id="sendBtn" class="sendBtn">Send</button>
      </div>
      <div class="hint">Replies are generated locally in your browser. Thumbs update the model (small in-browser training).</div>
    </main>
  </div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

  <!-- Firebase (modular v11) -->
  <script type="module">
    import { initFirebase, saveChatEvent, saveRewardEvent } from './firebase.js';
    import { loadVocab, createModel, generateWithRecording, applyRewardUpdate } from './model.js';

    const inputBox = document.getElementById('inputBox');
    const sendBtn = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');

    // in-memory session store for reward updates
    // turnId -> { promptTokens, sampledTokens }
    const SESSIONS = {};

    let vocab = null;
    let invVocab = null;
    let model = null;
    let initialized = false;

    async function init() {
      await initFirebase();                // init firebase
      vocab = await loadVocab('./vocab.json');
      invVocab = Object.fromEntries(Object.entries(vocab).map(([k,v])=>[v,k]));
      model = createModel(Object.keys(vocab).length);
      // Warm up model with a dummy batch so first inference is faster
      await tf.nextFrame();
      initialized = true;
    }
    init();

    function appendMessage(text, who, metaHtml=''){
      const div = document.createElement('div');
      div.className = 'bubble ' + (who==='user' ? 'user' : 'bot');
      div.innerHTML = escapeHtml(text) + (metaHtml?('<div class="metaRow">'+metaHtml+'</div>'):'');
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function escapeHtml(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    sendBtn.addEventListener('click', onSend);
    inputBox.addEventListener('keydown', e => { if(e.key==='Enter') onSend(); });

    async function onSend(){
      if(!initialized) return;
      const text = inputBox.value.trim();
      if(!text) return;
      inputBox.value = '';
      appendMessage(text, 'user');

      // generate reply (records sampled tokens & prompt tokens)
      const { replyText, promptTokens, sampledTokens, turnId } = await generateWithRecording(model, vocab, text, invVocab);

      // store session for later reward update
      SESSIONS[turnId] = { promptTokens, sampledTokens };

      // create vote buttons
      const metaHtml = `
        <div class="small">XYLXX GPT-1</div>
        <div class="votes">
          <button class="voteBtn" onclick="window.__sendReward('${turnId}',1)">üëç</button>
          <button class="voteBtn" onclick="window.__sendReward('${turnId}',-1)">üëé</button>
        </div>
      `;

      appendMessage(replyText, 'bot', metaHtml);

      // persist chat
      saveChatEvent({ user: text, bot: replyText, turnId, ts: Date.now() })
        .catch(e=>console.warn('save chat failed', e));
    }

    // Called by vote buttons
    window.__sendReward = async function(turnId, value){
      const sess = SESSIONS[turnId];
      if(!sess){ console.warn('no session', turnId); return; }
      // apply small in-browser policy gradient update
      try{
        await applyRewardUpdate(model, sess.promptTokens, sess.sampledTokens, value);
        saveRewardEvent({ turnId, reward: value, ts: Date.now() }).catch(e=>console.warn('save reward failed', e));
        // optional tiny UI feedback
        const note = document.createElement('div'); note.className='small'; note.style.marginTop='6px'; note.textContent = value>0 ? 'Thanks ‚Äî model updated üëç' : 'Feedback saved ‚Äî model updated üëé';
        messages.appendChild(note); messages.scrollTop = messages.scrollHeight;
      }catch(e){ console.error('reward update failed', e); }
    };
  </script>
</body>
</html>
