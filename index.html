<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XYLXX GPT-1</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="chat">
    <div id="messages"></div>
    <div id="input-bar">
      <input id="userInput" type="text" placeholder="Message XYLXX GPT-1..." />
      <button id="sendBtn">âž¤</button>
    </div>
  </div>

  <script type="module">
    import { buildModel, generateReply, loadVocab, rewardTrain } from "./model.js";
    import { saveChat, saveReward } from "./firebase.js";

    const messages = document.getElementById("messages");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    let vocab = {};
    let model;

    async function init() {
      vocab = await loadVocab("./vocab.json");
      model = buildModel(Object.keys(vocab).length);
    }
    init();

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      addMessage(text, "user");

      const reply = await generateReply(model, vocab, text);
      const msgId = Date.now().toString();
      addMessage(reply, "bot", msgId);

      await saveChat(text, reply, msgId);
    }

    function addMessage(text, who, msgId = null) {
      const div = document.createElement("div");
      div.className = "msg " + who;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      div.appendChild(bubble);

      if (who === "bot" && msgId) {
        const feedback = document.createElement("div");
        feedback.className = "feedback";

        const up = document.createElement("button");
        up.textContent = "ðŸ‘";
        up.onclick = async () => {
          await saveReward(msgId, 1);
          rewardTrain(model, vocab, text, true);
          feedback.style.display = "none";
        };

        const down = document.createElement("button");
        down.textContent = "ðŸ‘Ž";
        down.onclick = async () => {
          await saveReward(msgId, -1);
          rewardTrain(model, vocab, text, false);
          feedback.style.display = "none";
        };

        feedback.appendChild(up);
        feedback.appendChild(down);
        div.appendChild(feedback);
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // âœ… Hook Send Button + Enter Key
    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
