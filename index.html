<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>XYLXX GPT-1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chat">
    <div id="messages"></div>
    <div id="input">
      <input id="userInput" placeholder="Message XYLXX GPT-1...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

  <!-- App scripts -->
  <script type="module">
    import { buildModel, generateReply, loadVocab, rewardTrain } from "./model.js";
    import { saveChat, saveReward } from "./firebase.js";

    const messages = document.getElementById("messages");
    const input = document.getElementById("userInput");

    let vocab = {};
    let model;

    async function init() {
      vocab = await loadVocab("./vocab.json");
      model = buildModel(Object.keys(vocab).length);
    }
    init();

    function addMessage(text, who, msgId=null) {
      const div = document.createElement("div");
      div.className = "msg " + who;

      const span = document.createElement("span");
      span.textContent = text;
      div.appendChild(span);

      if (who === "bot" && msgId) {
        const feedback = document.createElement("div");
        feedback.className = "feedback";

        const up = document.createElement("button");
        up.textContent = "ðŸ‘";
        up.onclick = async () => {
          await saveReward(msgId, 1);
          rewardTrain(model, vocab, text, true);
          feedback.style.display = "none";
        };

        const down = document.createElement("button");
        down.textContent = "ðŸ‘Ž";
        down.onclick = async () => {
          await saveReward(msgId, -1);
          rewardTrain(model, vocab, text, false);
          feedback.style.display = "none";
        };

        feedback.appendChild(up);
        feedback.appendChild(down);
        div.appendChild(feedback);
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      addMessage(text, "user");
      const reply = await generateReply(model, vocab, text);

      const msgId = Date.now().toString();
      addMessage(reply, "bot", msgId);

      await saveChat(text, reply, msgId);
    }
    window.sendMessage = sendMessage;
  </script>
</body>
</html>
